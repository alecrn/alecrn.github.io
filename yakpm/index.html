<!DOCTYPE html>
<html>
<head>
<title>Yik Yak PM</title>
</head>
<body>
<div id="main"></div>
<script src="nacl-fast.min.js"></script>
<script src="react.js"></script>
<script src="jsx.js"></script>
<script type="text/jsx">

var query = (function() {
  var result = {};

  var s = location.search;

  if (s.length === 0) {
    return result;
  }

  var start = 1;

  while (start < s.length) {
    var equal = s.indexOf('=', start),
        ampersand = s.indexOf('&', equal + 1);

    if (ampersand === -1) {
      ampersand = s.length;
    }

    var key = s.substring(start, equal),
        val = s.substring(equal + 1, ampersand);

    result[key] = val;
    start = ampersand + 1;
  }

  return result;
})();

var alphabet = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';

function encode(x) {
  return nacl.util.encodeBase64(x).replace('+', '_');
}

function decode(x) {
  return nacl.util.decodeBase64(x.replace('_', '+'));
}

var nonce = (function() {
  var r = [];

  for (var i = 0; i < 24; i++) {
    r.push(0);
  }

  return new Uint8Array(r);
})();

var Alice = React.createClass({
  getInitialState: function() {
    var keypair = nacl.box.keyPair();

    return {
      myPkey:    keypair.publicKey,
      mySkey:    keypair.secretKey,
      theirPkey: '',
      message:   ''
    };
  },

  changeTheirPkey: function(e) {
    this.setState({ theirPkey: e.target.value });
  },

  changeMessage: function(e) {
    this.setState({ message: e.target.value });
  },

  render: function() {
    try {
      var theirPkey = decode(this.state.theirPkey),
          mySkey    = this.state.mySkey,
          message   = nacl.util.decodeUTF8(this.state.message),
          encrypted = nacl.box(message, nonce, theirPkey, mySkey);
    } catch (e) {
      console.log(e);
      var encrypted = null;
    }

    return <div>
      <h1>Yik Yak PM</h1>
      <p>Privately talk to another user on yik yak.</p>
      <p>First, send the other person <a href={'?other=true&pkey=' + encode(this.state.myPkey)}>this link</a>.</p>
      <p>They should send you their public key.  Enter the public key here:</p>
      <p><input type="text" value={this.state.theirPkey} onChange={this.changeTheirPkey}/></p>
      <p>Now type a message you only want them to see.  It can be a phone number
         or kik username, for instance.</p>
      <p><input type="text" value={this.state.message} onChange={this.changeMessage}/></p>
      {encrypted && <div>
        <p>Here is the encrypted message you can send them:</p>
        <p><code>{encode(encrypted)}</code></p>
      </div>}
    </div>;
  }
});

var Bob = React.createClass({
  getInitialState: function() {
    var keypair = nacl.box.keyPair();

    return {
      myPkey:    keypair.publicKey,
      mySkey:    keypair.secretKey,
      encrypted: ''
    };
  },

  changeEncrypted: function(e) {
    this.setState({ encrypted: e.target.value });
  },

  render: function() {
    try {
      var encrypted = decode(this.state.encrypted),
          mySkey    = this.state.mySkey,
          theirPkey = decode(query.pkey),
          decrypted = nacl.box.open(encrypted, nonce, theirPkey, mySkey);
    } catch (e) {
      var decrypted = null;
    }

    return <div>
      <h1>Yik Yak PM</h1>
      <p>You were sent this link because another user would like to send you
         a private message.</p>
      <p>This is your public key:</p>
      <p><code>{encode(this.state.myPkey)}</code></p>
      <p>Send it to them on yik yak.  They will send you an encrypted message.  Enter it below:</p>
      <p><input type="text" value={this.state.encrypted} onChange={this.changeEncrypted}/></p>
      { decrypted && <div>
        <p>Decrypted message:</p>
        <p><code>{nacl.util.encodeUTF8(decrypted)}</code></p>
      </div> }
    </div>;
  }
});

var Main = React.createClass({
  render: function() {
    if (query.other === 'true') {
      return <Bob/>;
    } else {
      return <Alice/>;
    }
  }
});

React.render(<Main/>, document.getElementById('main'));

</script>
</body>
</html>
